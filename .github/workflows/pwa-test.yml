name: PWA Quality Check

on:
  pull_request:
    branches: [prod, main]
  push:
    branches: [pwa-test-*]

jobs:
  pwa-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build PWA
        run: pnpm run build

      - name: Verify PWA Assets
        run: |
          echo "ğŸ” Verificando archivos PWA..."
          
          # Verificar manifest
          if [ -f "dist/manifest.webmanifest" ]; then
            echo "âœ… Manifest: dist/manifest.webmanifest"
            cat dist/manifest.webmanifest
          else
            echo "âŒ Manifest no encontrado"
            exit 1
          fi
          
          # Verificar Service Worker
          if [ -f "dist/sw.js" ]; then
            echo "âœ… Service Worker: dist/sw.js"
          else
            echo "âŒ Service Worker no encontrado"
            exit 1
          fi
          
          # Verificar registro de Service Worker
          if [ -f "dist/registerSW.js" ]; then
            echo "âœ… Service Worker Register: dist/registerSW.js"
          else
            echo "âŒ Service Worker Register no encontrado"
            exit 1
          fi
          
          # Verificar iconos
          if [ -f "dist/pwa-192x192.svg" ]; then
            echo "âœ… Icono 192x192 encontrado"
          else
            echo "âš ï¸ Icono 192x192 no encontrado"
          fi
          
          if [ -f "dist/pwa-512x512.svg" ]; then
            echo "âœ… Icono 512x512 encontrado"
          else
            echo "âš ï¸ Icono 512x512 no encontrado"
          fi

      - name: Install Lighthouse CLI
        run: npm install -g @lhci/cli lighthouse

      - name: Start preview server
        run: |
          pnpm run preview &
          sleep 10
        
      - name: Run Lighthouse PWA Audit
        run: |
          echo "ğŸ” Ejecutando auditorÃ­a PWA con Lighthouse..."
          lighthouse http://localhost:4173 \
            --only-categories=pwa \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --output=json \
            --output-path=lighthouse-pwa.json
          
          # Mostrar resultados
          echo "ğŸ“Š Resultados de la auditorÃ­a PWA:"
          cat lighthouse-pwa.json | jq '.categories.pwa.score'

      - name: Check PWA Score
        run: |
          score=$(cat lighthouse-pwa.json | jq '.categories.pwa.score')
          echo "PWA Score: $score"
          
          if (( $(echo "$score >= 0.9" | bc -l) )); then
            echo "âœ… PWA Score excelente: $score"
          elif (( $(echo "$score >= 0.7" | bc -l) )); then
            echo "âš ï¸ PWA Score aceptable: $score"
          else
            echo "âŒ PWA Score bajo: $score"
            exit 1
          fi

      - name: PWA Summary
        run: |
          echo "ğŸ“± PWA Quality Check Completado"
          echo "================================"
          echo "âœ… Manifest configurado"
          echo "âœ… Service Worker generado" 
          echo "âœ… Iconos disponibles"
          echo "âœ… Build PWA exitoso"
          echo ""
          echo "ğŸš€ Listo para deployment a producciÃ³n!"